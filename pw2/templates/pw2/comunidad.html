document.addEventListener('DOMContentLoaded', async () => {
    // Proteger la ruta, el usuario debe estar logueado
    window.auth.protectRoute();

    const container = document.getElementById('publicaciones-container');
    const searchForm = document.getElementById('search-form-nav');
    const searchInput = document.getElementById('search-input-nav');
    const tituloSeccion = document.getElementById('titulo-seccion');

    // Función principal para cargar publicaciones, ahora acepta una búsqueda
    async function cargarPublicaciones(query = '') {
        try {
            let endpoint = '/publicaciones/';
            if (query) {
                endpoint += `?search=${encodeURIComponent(query)}`;
                tituloSeccion.innerHTML = `Resultados para: <span class="query-term">"${query}"</span>`;
            } else {
                tituloSeccion.textContent = 'Comunidad';
            }
            const publicaciones = await window.api.fetchAPI(endpoint);
            renderPublicaciones(publicaciones);
        } catch (error) {
            container.innerHTML = '<p>Error al cargar las publicaciones. Inténtalo de nuevo más tarde.</p>';
            console.error(error);
        }
    }

    function renderPublicaciones(publicaciones) {
        if (publicaciones.length === 0) {
            container.innerHTML = '<p>No se encontraron publicaciones que coincidan. ¡Sé el primero en publicar!</p>';
            return;
        }

        container.innerHTML = '';
        publicaciones.forEach(pub => {
            const fecha = new Date(pub.fecha_publicacion).toLocaleDateString('es-ES', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            const card = document.createElement('div');
            card.className = 'publicacion-card';
            
            card.innerHTML = `
                <div class="publicacion-header">
                    <img src="${pub.autor.foto_perfil || '/static/pw2/images/Haerin.jpg'}" alt="Foto de perfil del autor">
                    <div class="publicacion-autor-info">
                        <span class="nombre">${pub.autor.nombre}</span>
                        <p class="fecha"><a href="/perfil/${pub.autor.nickname}/">@${pub.autor.nickname}</a> - ${fecha}</p>
                    </div>
                </div>
                <div class="publicacion-body" style="cursor: pointer;" onclick="window.location.href='/publicaciones/${pub.id}/'">
                    <h3>${pub.titulo}</h3>
                    <p>${pub.descripcion}</p>
                </div>
                <div class="publicacion-footer">
                    <div class="reacciones-info">
                        <i class="fas fa-heart"></i>
                        <span>${pub.reacciones_count} Reacciones</span>
                    </div>
                    <div class="comentarios-info" onclick="window.location.href='/publicaciones/${pub.id}/'">
                        <i class="fas fa-comment"></i>
                        <span>Comentarios</span>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // Manejar el envío del formulario de búsqueda
    searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const query = searchInput.value.trim();
        cargarPublicaciones(query);
    });

    // Comprobar si hay una búsqueda pendiente desde otra página (como index)
    const pendingQuery = sessionStorage.getItem('searchQuery');
    if (pendingQuery) {
        searchInput.value = pendingQuery;
        cargarPublicaciones(pendingQuery);
        sessionStorage.removeItem('searchQuery'); // Limpiar para no repetir la búsqueda
    } else {
        // Carga inicial sin búsqueda
        cargarPublicaciones();
    }
});